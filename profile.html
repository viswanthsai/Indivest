<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - StoxMate</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="loader.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loader">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
        <div class="loading-logo">Stox<span class="logo-accent">Mate</span></div>
        <div class="loading-message">Loading your profile...</div>
    </div>

    <!-- Navigation Bar -->
    <nav>
        <div class="logo">
            <span class="logo-text">Stox<span class="logo-accent">Mate</span></span>
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="allocation.html">Allocation Tool</a>
            <a href="market-insights.html">Market Insights</a>
            <a href="ai-advisor.html">AI Advisor</a>
            <a href="profile.html" class="active">Profile</a>
        </div>
        <div class="auth-buttons">
            <!-- Will be dynamically populated based on authentication status -->
        </div>
        <div class="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    </nav>

    <!-- Profile Header -->
    <section class="profile-header">
        <div class="container">
            <div class="profile-header-content">
                <div class="profile-avatar">
                    <img src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff&size=128" alt="Profile Picture" id="profile-image">
                    <button class="edit-avatar" id="edit-avatar-btn">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-info">
                    <h1 id="user-displayname">User</h1>
                    <p id="user-email">user@example.com</p>
                    <div class="profile-badges">
                        <span class="badge premium">Premium User</span>
                        <span class="badge experience">New Investor</span>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="stat-value" id="investments-count">0</span>
                        <span class="stat-label">Investments</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value positive" id="overall-return">+0.0%</span>
                        <span class="stat-label">Overall Return</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="portfolio-value">â‚¹0</span>
                        <span class="stat-label">Portfolio Value</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Content -->
    <section class="profile-content">
        <div class="container">
            <div class="profile-tabs">
                <button class="tab-button active" data-tab="personal">Personal Details</button>
                <button class="tab-button" data-tab="investment">Investment Preferences</button>
                <button class="tab-button" data-tab="security">Security</button>
                <button class="tab-button" data-tab="notifications">Notifications</button>
            </div>

            <!-- Tab Contents -->
            <div class="tab-content active" id="personal-tab">
                <div class="profile-section">
                    <h2>Personal Information</h2>
                    <form class="profile-form" id="personal-info-form">
                        <div class="form-group">
                            <label for="fullname">Full Name</label>
                            <input type="text" id="fullname" class="form-control" placeholder="Your full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" class="form-control" placeholder="Your phone number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dob">Date of Birth</label>
                                <input type="date" id="dob" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="pan">PAN Number</label>
                                <input type="text" id="pan" class="form-control" placeholder="ABCDE1234F">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Address</label>
                            <textarea id="address" class="form-control" placeholder="Your full address"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-content" id="investment-tab">
                <div class="profile-section">
                    <h2>Investment Preferences</h2>
                    <form class="profile-form" id="investment-prefs-form">
                        <div class="form-group">
                            <label>Risk Tolerance</label>
                            <div class="risk-slider-container">
                                <input type="range" min="1" max="5" value="3" class="risk-slider" id="risk-tolerance">
                                <div class="risk-labels">
                                    <span>Conservative</span>
                                    <span>Moderate</span>
                                    <span>Aggressive</span>
                                </div>
                                <div class="risk-value">Moderate</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Investment Goals</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="goals" value="retirement"> Retirement Planning
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="goals" value="wealth"> Wealth Creation
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="goals" value="tax"> Tax Saving
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="goals" value="education"> Children's Education
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="goals" value="home"> Home Purchase
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-content" id="security-tab">
                <div class="profile-section">
                    <h2>Security Settings</h2>
                    <form class="profile-form" id="security-form">
                        <div class="form-group">
                            <h3>Change Password</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="current-password">Current Password</label>
                                    <input type="password" id="current-password" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="new-password">New Password</label>
                                    <input type="password" id="new-password" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="confirm-password">Confirm New Password</label>
                                    <input type="password" id="confirm-password" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-content" id="notifications-tab">
                <div class="profile-section">
                    <h2>Notification Preferences</h2>
                    <form class="profile-form" id="notifications-form">
                        <div class="form-group">
                            <h3>Communication Channels</h3>
                            <div class="notification-channels">
                                <div class="channel-option">
                                    <div class="channel-info">
                                        <i class="fas fa-envelope"></i>
                                        <span>Email</span>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" name="channel_email" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <div class="channel-option">
                                    <div class="channel-info">
                                        <i class="fas fa-mobile-alt"></i>
                                        <span>SMS</span>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" name="channel_sms">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Status Message -->
    <div class="status-message" id="status-message"></div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <span class="logo-text">Stox<span class="logo-accent">Mate</span></span>
                <p>AI-powered investment solutions</p>
            </div>
            
            <div class="footer-links">
                <div class="link-group">
                    <h4>Product</h4>
                    <a href="#">Features</a>
                    <a href="#">Pricing</a>
                    <a href="#">Testimonials</a>
                </div>
                
                <div class="link-group">
                    <h4>Resources</h4>
                    <a href="#">Blog</a>
                    <a href="market-insights.html">Market Insights</a>
                    <a href="#">Learning Center</a>
                </div>
                
                <div class="link-group">
                    <h4>Company</h4>
                    <a href="#">About Us</a>
                    <a href="#">Careers</a>
                    <a href="#">Contact</a>
                </div>
                
                <div class="link-group">
                    <h4>Legal</h4>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Disclaimers</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 StoxMate. All rights reserved.</p>
            <div class="social-icons">
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/auth-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab switching
            initTabs();
            
            // Handle authentication and profile loading
            checkAuthentication();
            
            // Set up form submissions
            setupFormHandlers();
            
            // Hide loading screen
            setTimeout(function() {
                document.getElementById('loading-screen').style.display = 'none';
            }, 700);
        });
        
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons and tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Show corresponding tab
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function checkAuthentication() {
            // Check if user is logged in
            const storedUser = localStorage.getItem('stoxmate_user') || localStorage.getItem('indivest_user');
            
            if (!storedUser) {
                // No user found, redirect to login
                window.location.href = 'login.html?redirect=profile';
            } else {
                try {
                    // Parse user data and update UI
                    const user = JSON.parse(storedUser);
                    loadUserProfile(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    showStatusMessage('Error loading profile. Please try logging in again.', 'error');
                }
            }
        }
        
        function loadUserProfile(user) {
            // Update profile header
            document.getElementById('user-displayname').textContent = user.user_metadata?.full_name || 'User';
            document.getElementById('user-email').textContent = user.email;
            
            // Update profile image
            const profileImage = document.getElementById('profile-image');
            const name = user.user_metadata?.full_name || 'User';
            profileImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff&size=128`;
            
            // Fill personal info form
            document.getElementById('fullname').value = user.user_metadata?.full_name || '';
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.user_metadata?.phone_number || '';
            
            // Load additional profile data if available
            if (user.user_metadata?.dob) {
                document.getElementById('dob').value = user.user_metadata.dob;
            }
            if (user.user_metadata?.pan) {
                document.getElementById('pan').value = user.user_metadata.pan;
            }
            if (user.user_metadata?.address) {
                document.getElementById('address').value = user.user_metadata.address;
            }
        }
        
        function setupFormHandlers() {
            // Personal info form
            const personalForm = document.getElementById('personal-info-form');
            if (personalForm) {
                personalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePersonalInfo();
                });
            }
            
            // Investment preferences form
            const investmentForm = document.getElementById('investment-prefs-form');
            if (investmentForm) {
                investmentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveInvestmentPreferences();
                });
            }
            
            // Security form
            const securityForm = document.getElementById('security-form');
            if (securityForm) {
                securityForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    changePassword();
                });
            }
            
            // Notifications form
            const notificationsForm = document.getElementById('notifications-form');
            if (notificationsForm) {
                notificationsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveNotificationSettings();
                });
            }
        }
        
        function savePersonalInfo() {
            // Get form values
            const fullName = document.getElementById('fullname').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const dob = document.getElementById('dob').value;
            const pan = document.getElementById('pan').value.trim();
            const address = document.getElementById('address').value.trim();
            
            // Simple validation
            if (!fullName) {
                showStatusMessage('Please enter your full name', 'error');
                return;
            }
            
            // Get user data
            const storedUser = localStorage.getItem('stoxmate_user') || localStorage.getItem('indivest_user');
            if (!storedUser) {
                showStatusMessage('User session not found. Please login again.', 'error');
                return;
            }
            
            try {
                let user = JSON.parse(storedUser);
                
                // Update user_metadata
                user.user_metadata = user.user_metadata || {};
                user.user_metadata.full_name = fullName;
                user.user_metadata.phone_number = phone;
                user.user_metadata.dob = dob;
                user.user_metadata.pan = pan;
                user.user_metadata.address = address;
                
                // Save updated user data to localStorage
                localStorage.setItem('stoxmate_user', JSON.stringify(user));
                
                // Update UI
                document.getElementById('user-displayname').textContent = fullName;
                
                // Update profile image
                const profileImage = document.getElementById('profile-image');
                profileImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=3b82f6&color=fff&size=128`;
                
                // Show success message
                showStatusMessage('Personal information saved successfully', 'success');
                
            } catch (e) {
                console.error('Error updating user data:', e);
                showStatusMessage('Failed to save personal information. Please try again.', 'error');
            }
        }
        
        function saveInvestmentPreferences() {
            // Get risk tolerance
            const riskTolerance = document.getElementById('risk-tolerance').value;
            
            // Get selected goals
            const goalCheckboxes = document.querySelectorAll('input[name="goals"]:checked');
            const goals = Array.from(goalCheckboxes).map(cb => cb.value);
            
            // Get stored user data
            const storedUser = localStorage.getItem('stoxmate_user') || localStorage.getItem('indivest_user');
            if (!storedUser) {
                showStatusMessage('User session not found. Please login again.', 'error');
                return;
            }
            
            try {
                let user = JSON.parse(storedUser);
                
                // Update user_metadata
                user.user_metadata = user.user_metadata || {};
                user.user_metadata.risk_tolerance = riskTolerance;
                user.user_metadata.investment_goals = goals;
                
                // Save updated user data to localStorage
                localStorage.setItem('stoxmate_user', JSON.stringify(user));
                
                // Show success message
                showStatusMessage('Investment preferences saved successfully', 'success');
                
            } catch (e) {
                console.error('Error updating user data:', e);
                showStatusMessage('Failed to save investment preferences. Please try again.', 'error');
            }
        }
        
        function changePassword() {
            // Get password values
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                showStatusMessage('Please fill in all password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStatusMessage('New passwords do not match', 'error');
                return;
            }
            
            // Password strength check
            if (newPassword.length < 8) {
                showStatusMessage('New password must be at least 8 characters long', 'error');
                return;
            }
            
            // In a real application, you would make an API call to change the password
            // For this demo, we'll just simulate success
            
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            // Show success message
            showStatusMessage('Password changed successfully', 'success');
        }
        
        function saveNotificationSettings() {
            // Get notification settings
            const emailNotifications = document.querySelector('input[name="channel_email"]').checked;
            const smsNotifications = document.querySelector('input[name="channel_sms"]').checked;
            
            // Get stored user data
            const storedUser = localStorage.getItem('stoxmate_user') || localStorage.getItem('indivest_user');
            if (!storedUser) {
                showStatusMessage('User session not found. Please login again.', 'error');
                return;
            }
            
            try {
                let user = JSON.parse(storedUser);
                
                // Update user_metadata
                user.user_metadata = user.user_metadata || {};
                user.user_metadata.notifications = {
                    email: emailNotifications,
                    sms: smsNotifications
                };
                
                // Save updated user data to localStorage
                localStorage.setItem('stoxmate_user', JSON.stringify(user));
                
                // Show success message
                showStatusMessage('Notification settings saved successfully', 'success');
                
            } catch (e) {
                console.error('Error updating user data:', e);
                showStatusMessage('Failed to save notification settings. Please try again.', 'error');
            }
        }
        
        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type + ' show';
            
            // Auto-hide after 3 seconds
            setTimeout(function() {
                statusElement.className = 'status-message';
            }, 3000);
        }
    </script>
</body>
</html>